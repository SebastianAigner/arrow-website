"use strict";(self.webpackChunkarrow_website=self.webpackChunkarrow_website||[]).push([[7491],{51408:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>i,default:()=>h,frontMatter:()=>r,metadata:()=>c,toc:()=>a});var s=t(85893),o=t(11151);const r={title:"With Ktor",sidebar_position:1},i="SuspendApp with Ktor",c={id:"ecosystem/suspendapp/ktor",title:"With Ktor",description:"There are some cases where it is convenient to gracefully shutdown a Ktor server. Basically, it is about giving some",source:"@site/content/docs/ecosystem/suspendapp/ktor.md",sourceDirName:"ecosystem/suspendapp",slug:"/ecosystem/suspendapp/ktor",permalink:"/ecosystem/suspendapp/ktor",draft:!1,unlisted:!1,editUrl:"https://github.com/arrow-kt/arrow-website/edit/main/content/docs/ecosystem/suspendapp/ktor.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{title:"With Ktor",sidebar_position:1},sidebar:"ecosystemSidebar",previous:{title:"SuspendApp",permalink:"/ecosystem/suspendapp/"},next:{title:"With Kafka",permalink:"/ecosystem/suspendapp/kafka"}},d={},a=[];function l(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"suspendapp-with-ktor",children:"SuspendApp with Ktor"}),"\n",(0,s.jsx)(n.p,{children:"There are some cases where it is convenient to gracefully shutdown a Ktor server. Basically, it is about giving some\ntime to the server to finish some pending processing before turning it off."}),"\n",(0,s.jsxs)(n.p,{children:["Kubernetes is a good example of this need. When we're working with Kubernetes we often need to\nsupport ",(0,s.jsx)(n.a,{href:"https://cloud.google.com/blog/products/containers-kubernetes/kubernetes-best-practices-terminating-with-grace",children:"Graceful Shutdown"}),".\nKubernetes sends ",(0,s.jsx)(n.code,{children:"SIGTERM"})," to our ",(0,s.jsx)(n.em,{children:"Pod"})," to signal it needs to gracefully shutdown.\nHowever, there is an issue which doesn't allow us to immediately shutdown when we receive ",(0,s.jsx)(n.code,{children:"SIGTERM"})," from Kubernetes.\nOur pod can still receive traffic ",(0,s.jsx)(n.strong,{children:"after"})," ",(0,s.jsx)(n.code,{children:"SIGTERM"}),", so we need to apply additional back-pressure to delay graceful\nshutdown."]}),"\n",(0,s.jsx)(n.admonition,{title:"Additional reading",type:"info",children:(0,s.jsxs)(n.p,{children:["More information on this can be found in this blog by ",(0,s.jsx)(n.a,{href:"https://philpearl.github.io/post/k8s_ingress/",children:"Phil Pearl"}),",\nand on ",(0,s.jsx)(n.a,{href:"https://learnk8s.io/graceful-shutdown",children:"learnk8s.io"}),"."]})}),"\n",(0,s.jsxs)(n.p,{children:["The module ",(0,s.jsx)(n.code,{children:"suspendapp-ktor"})," provides a ",(0,s.jsx)(n.code,{children:"server"})," constructor that lifts the Ktor ",(0,s.jsx)(n.code,{children:"ApplicationEngine"})," in to a Resource,\nrepresenting the ",(0,s.jsx)(n.em,{children:"Engine"})," running an ",(0,s.jsx)(n.code,{children:"Application"}),"(i.e ",(0,s.jsx)(n.code,{children:"Netty"}),") while supporting ",(0,s.jsx)(n.a,{href:"https://ktor.io/docs/auto-reload.html",children:"auto-reload"}),".\nThe example below introduces graceful shutdown for Kubernetes;\nwe additionally use ",(0,s.jsx)(n.code,{children:"awaitCancellation"})," to ",(0,s.jsx)(n.em,{children:"await"})," ",(0,s.jsx)(n.code,{children:"SIGTERM"}),", ",(0,s.jsx)(n.code,{children:"SIGINT"})," or other shutdown hooks."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kotlin",children:'fun main() = SuspendApp {\n  resourceScope {\n    server(Netty) {\n      routing {\n        get("/ping") {\n          call.respond("pong")\n        }\n      }\n    }\n    awaitCancellation()\n  }\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["When the ",(0,s.jsx)(n.code,{children:"release"})," function of our ",(0,s.jsx)(n.code,{children:"ApplicationEngine"})," is called, there is a ",(0,s.jsx)(n.code,{children:"wait"})," period before the beginning of the stop\nprocess (defaulted to ",(0,s.jsx)(n.code,{children:"30.seconds"}),"), this gives Kubernetes enough time to do all its network management before we shut down.\nTwo more parameters are available:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"grace"})," which sets the number of seconds during which already inflight requests are allowed to continue before the shutdown process begins,"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"timeout"})," which sets the number of seconds after which the server will be forceably shutdown."]}),"\n"]}),"\n",(0,s.jsx)(n.admonition,{title:"Development mode",type:"note",children:(0,s.jsxs)(n.p,{children:["In the case that Ktor server is set in\n",(0,s.jsx)(n.a,{href:"https://ktor.io/docs/development-mode.html",children:"development mode"}),", the ",(0,s.jsx)(n.code,{children:"wait"})," period is ignored."]})})]})}function h(e={}){const{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},11151:(e,n,t)=>{t.d(n,{Z:()=>c,a:()=>i});var s=t(67294);const o={},r=s.createContext(o);function i(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);